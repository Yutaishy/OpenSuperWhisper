# リアルタイム文字起こし機能 要件定義 変更履歴

## 2024-08-02 技術検証に基づく改善

### 変更内容

#### 1. 音韻境界を考慮した分割ロジックの追加
**理由**: 単純な時間分割では単語の途中で切れるリスクがあるため

**変更前**:
```
2分経過: 無音関係なく強制的に分割してAPI送信
```

**変更後**:
```
1分50秒経過: 優先分割ポイント検索
  → 0.5秒以上の無音: そこで分割
  → 無音がない: 音量最小点で分割
2分経過: ゼロクロッシング点で強制分割（音の途切れ最小化）
```

#### 2. 時系列順表示の必須化
**理由**: 順序が入れ替わると文章が読みづらくユーザーが混乱するため

**変更前**:
```
成功したものから順次表示（順番は保証しない）
```

**変更後**:
```
時系列順表示ルール:
- 処理完了したチャンクのみ表示
- 未完了チャンクは空白で場所を確保
- 順番が前後することは絶対にない
```

#### 3. エラーの透明性確保
**理由**: エラーを完全に隠すと重要な部分の欠落にユーザーが気づけないため

**変更前**:
```
ユーザーへの通知なし（録音を妨げない）
```

**変更後**:
```
エラー情報をエラーエリアに控えめに表示
- 小さいエラーアイコン（🔸）を表示
- 点滅や音は出さない
- エラー件数をカウンターで表示
```

### 技術的改善点

1. **find_optimal_split_point関数の追加**
   - 音韻境界検出アルゴリズム
   - ゼロクロッシング点での分割

2. **結果表示制御の改善**
   - ステータス管理（completed/processing/error）
   - プレースホルダー表示機能

3. **注意事項の追加**
   - 単語の途中で音声を切断しない
   - エラーを完全に隠さない
   - 音韻境界を考慮した分割

これらの改善により、より自然で使いやすいリアルタイム文字起こし機能を実現できます。

## 2024-08-02 キャンセル機能の追加

### 追加背景
ユーザーから「録音途中や処理中でも、すべてをキャンセルしたい場合がある」という要望を受けて追加。

### 追加内容

#### 1. Escキーによる緊急停止機能
**追加仕様**:
- どの状態でもEscキーで全処理を即座にキャンセル
- 録音、API呼び出し、リトライをすべて中断
- 部分的な結果も破棄（クリーンキャンセル）

#### 2. ポップアップステータスの追加
**新規ステータス**:
- **Cancelling...** - キャンセル処理中
- **Cancelled** - キャンセル完了（2秒後に自動消去）

#### 3. 技術的実装
**追加要素**:
```python
self.cancel_flag = False    # キャンセルフラグ
self.api_futures = []       # 実行中のAPI呼び出しリスト

def cancel_all_processing(self):
    # 全処理の中断とクリーンアップ
```

#### 4. ファイル追加
- `cancel_handler.py` - キャンセル処理の集中管理

### ユーザーメリット
1. **即座の中断**: 誤操作や不要な録音をすぐに停止
2. **クリーンな状態**: 中途半端な結果を残さない
3. **シンプルな操作**: Escキー1つで全キャンセル

## 2024-08-02 フォーマット処理とメモリ最適化の追加

### 追加内容

#### 1. フォーマット処理の仕様
- **各チャンクごとに即座にフォーマット**: ASR完了後すぐに整形処理
- **Formatted Textタブもリアルタイム更新**: 両タブが同期して更新
- **プリセット固定**: 録音開始後はプリセット変更不可

#### 2. チャンク境界のオーバーラップ処理
- **0.5秒の音声重複**: 文脈の継続性を確保
- **重複テキストの自動除去**: アルゴリズムで検出・削除
- **音韻境界の保護**: 単語の途切れを防止

#### 3. メモリ最適化
- **音声データの即時削除**: テキスト取得後すぐに解放
- **ガベージコレクション**: 明示的なメモリクリーンアップ
- **長時間録音対応**: 2時間以上の録音でも安定動作

#### 4. キャンセル時の確認ダイアログ
- **3つの選択肢**: 保存/破棄/キャンセル
- **部分的な保存**: 処理済みテキストのみ保持可能
- **柔軟な対応**: ユーザーの意図に応じた処理

### 技術的実装
```python
# オーバーラップ処理
overlap_samples = int(0.5 * sample_rate)  # 0.5秒分

# メモリ最適化
def on_chunk_completed(self, chunk_id, text_result):
    del self.processing_chunks[chunk_id]  # 音声データ削除
    gc.collect()  # メモリ解放
```

## 2024-08-02 最終検証に基づく改善

### 改善内容

#### 1. 言語別オーバーラップ時間の調整
- **日本語**: 0.5秒 → **0.8秒**（文節を考慮）
- **英語**: 0.5秒（維持）
- **動的調整**: 言語検出結果に基づいて自動変更

#### 2. 高度な重複テキスト除去アルゴリズム
- **動的ウィンドウサイズ**: テキストの10%（最大50文字）
- **3段階の検出**:
  1. 完全一致検索
  2. 編集距離による類似度検索
  3. 形態素解析による文節境界検出

#### 3. フォーマット処理の即時実行
- **変更前**: 3チャンクバッファリング
- **変更後**: 各チャンクごとに即座にフォーマット
- **メリット**: 真のリアルタイム表示を実現

#### 4. エラーチャンクの取り扱い
- **エラー部分**: 「[エラー: 取得失敗]」として表示
- **フォーマット**: エラーを含む全体をフォーマット処理
- **一貫性**: 文章の流れを保持

### 追加された実装詳細
```python
def remove_duplicate_text_advanced(self, text1, text2):
    # 動的ウィンドウサイズ
    window_size = min(len(text1) // 10, len(text2) // 10, 50)
    
    # 多段階の重複検出
    # 1. 完全一致
    # 2. ファジーマッチング
    # 3. 形態素境界での結合
```

これらの改善により、より自然で高品質なリアルタイム文字起こしを実現します。

## 2024-08-02 最終妥当性検証に基づく修正

### 修正内容

#### 1. 効率的なメモリ管理
- **変更前**: 毎回 `gc.collect()` を実行
- **変更後**: 10チャンクごとに実行
- **効果**: パフォーマンス向上

#### 2. オーバーラップを考慮した無音検出
- **問題**: 0.8秒のオーバーラップにより、実質0.7秒の無音しか検出できない
- **解決**: 実効的な無音時間 = 1.5秒 + 0.8秒 = 2.3秒
- **実装**: `effective_silence_duration = 1.5 + overlap_duration`

#### 3. 段階的な重複除去実装
- **Phase 1**: シンプルな文字列マッチングのみ
- **Phase 2以降**: 高度なアルゴリズム（将来実装）
- **理由**: リアルタイム性を優先

#### 4. エラーリトライの制限
- **変更前**: 3回まで再試行
- **変更後**: 1回のみ再試行
- **効果**: 過度なAPI呼び出しを防止

### 削除された懸念事項
- **読みながら話す際の混乱**: 1分30秒のタイムラグがあるため、問題にならないことが判明
- **APIコスト**: 長時間使用は想定外のため、考慮不要
- **フォーマットの一貫性**: 実用上問題ないレベル

これで要件定義書は実装可能な完成版となりました。