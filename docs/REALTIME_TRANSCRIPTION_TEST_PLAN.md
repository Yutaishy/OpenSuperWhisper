# リアルタイム文字起こし機能 テスト計画書

## 概要
本ドキュメントは、OpenSuperWhisperのリアルタイム文字起こし機能の包括的なテスト計画を定義します。

## テスト環境

### 必要な環境
- Windows 10/11
- Python 3.8+
- 有効なOpenAI APIキー
- マイク（録音テスト用）
- 安定したインターネット接続

### テストツール
- `test_realtime_integration.py` - 統合テスト
- `test_e2e_realtime.py` - エンドツーエンドテスト
- `performance_profiler.py` - パフォーマンス分析

## テストカテゴリ

### 1. 単体テスト

#### 1.1 RealtimeRecorder
- [ ] 録音開始・停止
- [ ] チャンク境界検出（60秒、90秒、120秒）
- [ ] 無音検出（1.5秒、0.5秒）
- [ ] オーバーラップ処理（日本語0.8秒、英語0.5秒）
- [ ] 音韻境界検出アルゴリズム

#### 1.2 ChunkProcessor
- [ ] 並列処理（最大3ワーカー）
- [ ] チャンク状態管理
- [ ] メモリ管理（10チャンクごとのGC）
- [ ] 重複テキスト除去

#### 1.3 CancelHandler
- [ ] ESCキー検出
- [ ] 確認ダイアログ表示
- [ ] 保存/破棄/キャンセル処理

#### 1.4 RetryManager
- [ ] エラータイプ別リトライ設定
- [ ] リトライスケジューリング
- [ ] 最大1回制限

### 2. 統合テスト

#### 2.1 録音フロー
```bash
python tests/test_realtime_integration.py
```

テスト項目：
- [ ] 2分30秒録音 → 2チャンク生成
- [ ] 1分35秒で無音 → 適切な分割
- [ ] チャンク間のオーバーラップ確認
- [ ] 時系列順序の保証

#### 2.2 エラー処理
- [ ] ネットワークエラー時の継続録音
- [ ] API制限時の自動リトライ
- [ ] 認証エラーの適切な処理

### 3. エンドツーエンドテスト

#### 3.1 UI操作テスト
```bash
python tests/test_e2e_realtime.py
```

テスト手順：
1. [ ] アプリケーション起動
2. [ ] 録音ボタンクリック
3. [ ] 1分以上録音
4. [ ] ステータス表示確認（"Live Transcribing"）
5. [ ] 停止ボタンクリック
6. [ ] 結果表示確認

#### 3.2 グローバルホットキーテスト
- [ ] Ctrl+Space で録音開始
- [ ] 再度 Ctrl+Space で録音停止
- [ ] バックグラウンドでの動作確認

#### 3.3 キャンセルテスト
- [ ] 録音中にESCキー押下
- [ ] 確認ダイアログ表示
- [ ] 各選択肢の動作確認

### 4. パフォーマンステスト

#### 4.1 パフォーマンス分析
```bash
python tests/performance_profiler.py
```

測定項目：
- [ ] CPU使用率（目標: 平均50%以下）
- [ ] メモリ使用量（目標: 100MB以下の増加）
- [ ] チャンク処理時間
- [ ] API応答時間

#### 4.2 長時間録音テスト
- [ ] 30分連続録音
- [ ] メモリリークの確認
- [ ] パフォーマンス劣化の確認

### 5. 互換性テスト

#### 5.1 APIモデル互換性
- [ ] whisper-1
- [ ] gpt-4o-audio-preview

#### 5.2 フォーマッターモデル
- [ ] gpt-4o
- [ ] gpt-4o-mini
- [ ] o4-mini-high

### 6. エッジケーステスト

#### 6.1 極端な条件
- [ ] 完全無音の録音
- [ ] 非常に大きな音量
- [ ] 急激な音量変化
- [ ] 10時間以上の連続録音

#### 6.2 エラー条件
- [ ] APIキー無効
- [ ] ネットワーク切断
- [ ] ディスク容量不足
- [ ] メモリ不足

## テスト実行手順

### 基本的なテスト実行
```bash
# 1. 統合テスト
cd tests
python test_realtime_integration.py

# 2. E2Eテスト（実際のUIが起動）
python test_e2e_realtime.py

# 3. パフォーマンステスト
python performance_profiler.py
```

### 手動テストシナリオ

#### シナリオ1: 基本的な録音
1. OpenSuperWhisperを起動
2. 「Start Recording」をクリック
3. 2分間話す（途中で3秒の無音を含む）
4. 「Stop Recording」をクリック
5. 結果確認：
   - Transcriptionタブに生テキスト表示
   - Formatted Textタブに整形済みテキスト表示

#### シナリオ2: 長時間録音
1. 録音開始
2. 15分間録音（様々な音声パターン）
3. 録音停止
4. 確認項目：
   - 複数チャンクが正しく結合
   - メモリ使用量が適切
   - エラーなく完了

#### シナリオ3: エラーリカバリ
1. 録音開始
2. ネットワークを一時的に切断
3. ネットワークを復旧
4. 録音継続・停止
5. 確認：エラー箇所がスキップされ、他は正常処理

## 合格基準

### 機能要件
- ✅ 10分以上の録音が可能
- ✅ リアルタイムで結果表示
- ✅ 時系列順序の保証
- ✅ ESCキャンセル機能
- ✅ エラー時も録音継続

### パフォーマンス要件
- ✅ CPU使用率: 平均50%以下
- ✅ メモリ増加: 100MB以下/10分
- ✅ チャンク処理: 3並列で遅延なし

### 信頼性要件
- ✅ 30分連続録音で安定動作
- ✅ ネットワークエラーからの回復
- ✅ メモリリークなし

## トラブルシューティング

### よくある問題

#### 1. 録音が開始されない
- マイク権限を確認
- 他のアプリがマイクを使用していないか確認
- `sounddevice`の再インストール

#### 2. チャンクが作成されない
- 録音時間が60秒未満の可能性
- 音声レベルが低すぎる可能性
- ログで`RealtimeRecorder`の動作確認

#### 3. メモリ使用量が増加し続ける
- ガベージコレクションの動作確認
- `chunk_processor.chunks_deleted`のカウント確認
- 処理済みチャンクの削除確認

## まとめ

本テスト計画に従って、リアルタイム文字起こし機能の品質を確保します。
すべてのテストに合格することで、本番環境での安定動作を保証します。