# リアルタイム文字起こし機能 要件定義検証レポート

## エグゼクティブサマリー

要件定義の技術的妥当性を検証した結果、**基本設計は妥当**だが、以下の改善が必要：

1. **音声途切れ対策**: 音韻境界を考慮した分割アルゴリズム
2. **順序保証の必須化**: 結果表示は必ず時系列順に
3. **エラー通知の追加**: 静かなエラー表示でユーザーに透明性を提供

## 1. 検証結果の詳細

### 1.1 チャンク分割ルールの妥当性

#### ✅ 妥当な点
- **1分最小**: API効率とリアルタイム性のバランスが良い
- **1.5秒無音**: 自然な会話の間合い（0.5-2秒）の中央値
- **2分最大**: ファイルサイズ（約10.6MB）が25MB制限内

#### ⚠️ 要改善点
- **音声途切れリスク**: 単語の途中で切れる可能性

#### 🔧 改善案
```python
def find_optimal_split_point(audio_data, target_time):
    # 1. target_time の前後0.5秒を探索範囲とする
    # 2. 以下の優先順位で分割点を決定:
    #    a) 1.5秒以上の無音区間
    #    b) 0.5秒以上の無音区間
    #    c) 音量が最小の地点
    #    d) ゼロクロッシング点
    # 3. どれも見つからない場合のみ強制分割
```

### 1.2 並列処理の妥当性

#### ✅ 妥当な点
- **3並列**: OpenAI APIのレート制限（3000 RPM）に対して安全
- **メモリ使用**: 3チャンク×10.6MB = 約32MBで許容範囲
- **CPU負荷**: 現代のPCなら問題なし

#### ⚠️ 注意点
- **エラー時のリトライ**: レート制限への配慮が必要

#### 🔧 対策
```python
# レート制限管理
class RateLimiter:
    def __init__(self, max_rpm=3000):
        self.max_rpm = max_rpm
        self.request_times = deque()
    
    def wait_if_needed(self):
        # 直近1分のリクエスト数をチェック
        # 制限に近づいたら待機
```

### 1.3 エラー処理の妥当性

#### ✅ 妥当な点
- **録音優先**: ユーザーの作業を妨げない
- **自動リトライ**: ユーザーの手間を省く
- **3回制限**: 無限ループを防ぐ

#### ❌ 要改善点
- **透明性の欠如**: エラーをユーザーが認識できない
- **順序保証なし**: 文章の時系列が崩れる

#### 🔧 改善案
```
1. エラー表示を必須に（ただし控えめに）
2. 結果表示は必ず時系列順に（Option A採用）
3. 重要度インジケーター追加
```

### 1.4 技術的実現可能性

#### ✅ 実装可能な要素
- **基本的なチャンク分割**: 既存コードの拡張で対応可
- **並列API呼び出し**: ThreadPoolExecutorで実装
- **UI更新**: Qt Signalで非同期更新

#### ⚠️ 実装難易度が高い要素
- **ギャップレス録音**: バッファ管理が複雑
- **メモリ効率**: 長時間録音時の安定性確保
- **スレッド同期**: デッドロック回避

## 2. リスク分析

### 高リスク項目と対策

| リスク | 影響 | 発生確率 | 対策 |
|--------|------|----------|------|
| 音声途切れ | 文章の意味不明 | 中 | 音韻境界検出アルゴリズム |
| メモリ不足 | アプリクラッシュ | 低 | リングバッファ実装 |
| 順序混乱 | 読解困難 | 高 | 時系列順表示を必須化 |

### 中リスク項目と対策

| リスク | 影響 | 発生確率 | 対策 |
|--------|------|----------|------|
| API制限 | 処理停止 | 中 | レート制限管理 |
| 無音誤検出 | 不要な分割 | 中 | 動的閾値 + VAD |
| UI応答性低下 | 使いづらい | 低 | 非同期更新徹底 |

## 3. 最終推奨仕様

### 3.1 チャンク分割（改善版）
```
1分経過まで: 分割なし
↓
1分30秒経過後: 
  - 1.5秒無音があれば、音韻境界を考慮して分割
  - なければ継続
↓
1分50秒経過:
  - 0.5秒以上の無音または音量最小点で分割
↓
2分経過: ゼロクロッシング点で強制分割
```

### 3.2 結果表示（改善版）
```
Option A（時系列順）を採用:
- 処理完了したチャンクは内部バッファに保持
- 先行チャンクが完了次第、順番に表示
- 未完了部分は「処理中...」表示
```

### 3.3 エラー表示（改善版）
```
録音中:
- エラーアイコンを控えめに表示（点滅なし）
- 録音は継続

録音後:
- エラー詳細を下部に表示
- 自動リトライの進捗表示
- 成功したら自動的にエラー表示を消去
```

## 4. 実装推奨事項

### Phase 1（必須機能）
1. 基本的なチャンク分割（2分強制のみ）
2. 逐次API送信
3. 時系列順での結果表示

### Phase 2（品質向上）
1. 音韻境界を考慮した分割
2. エラー表示とリトライ
3. メモリ効率化

### Phase 3（最適化）
1. 動的無音検出
2. レート制限管理
3. パフォーマンスチューニング

## 5. 結論

現在の要件定義は**基本的に妥当**です。ただし、以下の3点を修正することで、より堅牢で使いやすいシステムになります：

1. **音声分割アルゴリズムの改善**（音韻境界考慮）
2. **結果表示の時系列保証**（Option A採用）
3. **エラーの透明性確保**（控えめな通知）

これらの改善により、技術的リスクを最小化しつつ、優れたユーザー体験を提供できます。